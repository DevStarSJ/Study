<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Weather Monitoring in RxJS</title>
  <style>
  #form {
    margin-bottom: 20px;
  }
  .location {
    float: left;
    padding: 10px;
    margin-right: 20px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .location p {
    margin-top: 10px;
    margin-bottom: 10px;
    text-align: center;
  }
  .zip { font-size: 2em; }
  .temp { font-size: 4em; }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="form">
      <label>Zip Code:</label>
      <input type="text" id="zipcode-input">
      <button id="add-location">Add Location</button>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.min.js"></script>
  <script>
  // our code will go here
  console.log('RxJS included?', !!Rx);

  const appContainer = document.getElementById('app-container');
  const zipcodeInput = document.getElementById('zipcode-input');
  const addLocationBtn = document.getElementById('add-location');

  const btnClickStream =
    Rx.Observable
      .fromEvent(addLocationBtn, 'click')
      .map(() => true)
      //.forEach(val => console.log('btnClickStream val', val));

  const zipInputStream =
    Rx.Observable
      .fromEvent(zipcodeInput, 'input')
      .map(e => e.target.value)
      .filter(zip => zip.length === 5)
      //.forEach(val => console.log('zipInputStream val', val));

  const zipcodeStream =
    btnClickStream
      .withLatestFrom(zipInputStream, (click, zip) => zip)
      .distinct()
      //.forEach(val => console.log('zipcodeStream val', val));

  // Create reusable temperature fetching stream
  // APPID í•„
  const getTemperature = zip =>
  fetch(`http://api.openweathermap.org/data/2.5/weather?q=${zip},us&units=imperial&appid=8fdc114f949daa789cae36631b244cab`)
          .then(res => res.json());

  const zipTemperatureStreamFactory = zip =>
    Rx.Observable
          .fromPromise(getTemperature(zip))
          .map(({ main: { temp } }) => ({ temp, zip }));

  // Get new zip at each button click, get its
  // temperature, and paint it to the screen
  zipcodeStream
          .flatMap(zipTemperatureStreamFactory)
          .forEach(({ zip, temp }) => {
    const locationEle = document.createElement('div');
  locationEle.id = `zip-${zip}`;
  locationEle.classList.add('location');
  const zipEle = document.createElement('p');
  zipEle.classList.add('zip');
  zipEle.innerText = zip;
  const tempEle = document.createElement('p');
  tempEle.classList.add('temp');
  tempEle.innerHTML = `${temp}&deg;F`;
  locationEle.appendChild(zipEle);
  locationEle.appendChild(tempEle);
  appContainer.appendChild(locationEle);
  zipcodeInput.value = '';
  });


  </script>
</body>
</html>
